<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spelling Practice App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        :root {
            --bg-color: #f0f7f8;
            --primary-color: #14b8a6; /* Teal 500 */
            --primary-hover: #0d9488; /* Teal 600 */
            --secondary-color: #475569; /* Slate 600 */
            --text-color: #334155; /* Slate 700 */
            --card-bg: rgba(255, 255, 255, 0.9);
            --border-color: #e2e8f0; /* Slate 200 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d1fae5' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 1.5rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05), 0 4px 6px -2px rgba(0,0,0,0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .glass-sidebar {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            border-radius: 0.75rem;
            padding: 0.875rem 1.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px 0 rgba(20, 184, 166, 0.3);
            border: none;
        }
        .btn-primary:hover {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 7px 20px 0 rgba(20, 184, 166, 0.35);
        }
        
        .btn-primary i {
            vertical-align: middle;
        }

        .btn-secondary {
            background-color: #f1f5f9; /* Slate 100 */
            color: var(--secondary-color);
            font-weight: 600;
            border-radius: 0.75rem;
            padding: 0.875rem 1.5rem;
            transition: all 0.2s;
            border: 1px solid var(--border-color);
        }
        .btn-secondary:hover {
            background-color: #e2e8f0; /* Slate 200 */
            transform: translateY(-2px);
        }
        
        .input-field {
            border: 2px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1rem 1.25rem;
            transition: border-color 0.3s, box-shadow 0.3s;
            width: 100%;
            font-size: 1rem;
            font-weight: 500;
            background-color: #f8fafc;
        }
        .input-field#spell-input {
            font-size: 1.25rem;
        }
        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(20, 184, 166, 0.2);
        }

        .correct-input { border-color: #22c55e; background-color: #f0fdf4; }
        .incorrect-input { border-color: #ef4444; background-color: #fef2f2; }

        .feedback.correct { color: #16a34a; }
        .feedback.incorrect { color: #dc2626; }
        
        .block-btn {
            background-color: #fff;
            color: var(--text-color);
            font-weight: 600;
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            transition: all 0.2s ease-in-out;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .block-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 10px -1px rgba(0,0,0,0.07);
            border-color: #cbd5e1;
        }
        .block-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .block-btn.slab { background-color: #fffbeb; color: #d97706; border-color: #fcd34d; }
        .block-btn.slab.active { background-color: #f59e0b; color: white; border-color: #f59e0b; }

        .block-btn.bar { background-color: #fff1f2; color: #e11d48; border-color: #fecdd3; }
        .block-btn.bar.active { background-color: #be123c; color: white; border-color: #be123c; }

        .progress-bar-bg { background-color: #e2e8f0; }
        .progress-bar-fg { background-color: var(--primary-color); transition: width 0.5s ease-out; }

        @keyframes point-up { 0% { transform: scale(1) translateY(0); opacity: 1; } 100% { transform: scale(1.5) translateY(-10px); opacity: 0; } }
        .point-increase { animation: point-up 0.6s ease-out; }

        @keyframes point-down { 0% { transform: scale(1) translateY(0); opacity: 1; } 100% { transform: scale(1.5) translateY(10px); opacity: 0; } }
        .point-decrease { animation: point-down 0.6s ease-out; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <main class="w-full max-w-4xl mx-auto">
        <header id="main-header" class="text-center mb-8">
            <h1 class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-teal-500 to-cyan-600 pb-2">SpellCraft AI</h1>
            <p class="text-slate-500 mt-2 text-lg">Hone your spelling skills. Choose a block to begin.</p>
        </header>

        <!-- Block Selection -->
        <div id="block-selection" class="card p-8">
             <div class="text-center mb-8">
                <button id="add-word-btn" class="btn-primary inline-flex items-center gap-2">
                    <i class="ph-bold ph-plus-circle text-xl"></i>
                    <span>Add New Words</span>
                </button>
             </div>
             <h2 class="text-xl font-bold text-slate-700 text-center mb-2">Word Blocks</h2>
             <p class="text-slate-500 text-center mb-6">Start with the basics.</p>
             <div id="block-container" class="flex flex-wrap justify-center gap-4">
                <!-- Block buttons will be generated here -->
             </div>
             <div id="slab-block-wrapper" class="mt-6 hidden">
                <div class="border-t my-6 border-slate-200"></div>
                <h2 class="text-xl font-bold text-slate-700 text-center mb-2">Practice Slabs</h2>
                <p class="text-slate-500 text-center mb-6">Review the words you found tricky.</p>
                <div id="slab-container" class="flex flex-wrap justify-center gap-4">
                </div>
             </div>
             <div id="bar-block-wrapper" class="mt-6 hidden">
                <div class="border-t my-6 border-slate-200"></div>
                <h2 class="text-xl font-bold text-slate-700 text-center mb-2">Focus Bars</h2>
                <p class="text-slate-500 text-center mb-6">Master the toughest words.</p>
                <div id="bar-container" class="flex flex-wrap justify-center gap-4">
                </div>
             </div>
        </div>

        <!-- Spelling App Card -->
        <div id="app-card" class="card hidden overflow-hidden">
            <div class="grid md:grid-cols-[280px_1fr]">
                <!-- Sidebar -->
                <div class="glass-sidebar p-6 flex flex-col justify-between">
                    <div>
                        <button id="home-btn" class="flex items-center gap-2 text-slate-600 font-semibold hover:text-teal-600 transition-colors mb-8">
                            <i class="ph ph-arrow-left"></i> Main Menu
                        </button>
                        <h3 class="font-bold text-slate-700 text-lg mb-4">Your Progress</h3>
                        <div id="progress-indicator" class="text-sm font-semibold text-slate-500 mb-2">Word 0 of 0</div>
                        <div class="w-full progress-bar-bg rounded-full h-2.5">
                            <div id="progress-bar" class="progress-bar-fg h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="text-center">
                         <p class="text-slate-500 font-medium mb-1">TOTAL SCORE</p>
                         <span id="live-score" class="font-bold text-5xl text-teal-500 transition-colors duration-300">0</span>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="p-8 md:p-12 flex flex-col justify-center">
                    <div class="text-center">
                        <p class="text-slate-500 mb-2 font-semibold tracking-wider text-sm">DEFINITION</p>
                        <p id="definition" class="text-2xl font-medium text-slate-800 leading-relaxed min-h-[64px]"></p>
                    </div>

                    <button id="hear-word" class="mt-6 mx-auto flex items-center gap-3 px-6 py-3 bg-teal-50 text-teal-700 font-semibold rounded-full hover:bg-teal-100 transition-colors text-lg">
                        <i class="ph-bold ph-speaker-high text-2xl"></i>
                        Hear the Word
                    </button>

                    <div class="mt-10">
                         <input type="text" id="spell-input" class="input-field text-center" placeholder="Type your spelling..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                         <div id="feedback-message" class="feedback text-center font-semibold mt-4 h-6 flex items-center justify-center gap-2"></div>
                    </div>

                    <div class="mt-8 grid grid-cols-2 gap-4">
                        <button id="skip-btn" class="btn-secondary w-full text-lg">Skip Word</button>
                        <button id="check-btn" class="btn-primary w-full text-lg">Check</button>
                    </div>
                    
                    <div class="flex justify-center gap-4 mt-6">
                        <button id="prev-word" class="bg-slate-200 hover:bg-slate-300 text-slate-600 w-12 h-12 flex items-center justify-center rounded-full text-xl transition-colors disabled:opacity-50"><i class="ph-bold ph-arrow-left"></i></button>
                        <button id="next-word" class="bg-slate-200 hover:bg-slate-300 text-slate-600 w-12 h-12 flex items-center justify-center rounded-full text-xl transition-colors"><i class="ph-bold ph-arrow-right"></i></button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Completion Screen -->
        <div id="completion-screen" class="card p-8 md:p-16 text-center hidden">
            <i class="ph-fill ph-confetti text-7xl text-teal-500"></i>
            <h2 class="text-4xl font-extrabold text-slate-800 mt-4">Block Complete!</h2>
            <p class="text-xl text-slate-500 mt-4">Fantastic work. Keep the momentum going!</p>
            <div id="final-score" class="text-xl font-medium text-slate-600 my-8 bg-teal-50 rounded-xl p-4"></div>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button id="retry-block" class="btn-primary">Practice Again</button>
                <button id="choose-another-block" class="btn-secondary">Choose Another Block</button>
            </div>
        </div>
    </main>

    <!-- Add Word Modal -->
    <div id="add-word-modal" class="fixed inset-0 bg-slate-900 bg-opacity-50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
        <div class="card w-full max-w-md p-8">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">Add a New Word</h2>
            <form id="add-word-form">
                <div class="mb-4">
                    <label for="new-word" class="block text-sm font-medium text-slate-600 mb-2">Word</label>
                    <input type="text" id="new-word" class="input-field w-full" required>
                </div>
                <div class="mb-6">
                    <label for="new-definition" class="block text-sm font-medium text-slate-600 mb-2">Definition</label>
                    <textarea id="new-definition" rows="3" class="input-field w-full" required></textarea>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancel-add-word" class="btn-secondary">Cancel</button>
                    <button type="submit" class="btn-primary">Save Word</button>
                </div>
            </form>
        </div>
    </div>

    <script src="words.js"></script>
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // App constants and variables
        const BLOCK_SIZE = 20;
        let wordBlocks = [];
        let incorrectWords = [];
        let barWords = [];
        let originalBlockCount = 0;
        let currentBlockIndex = -1;
        let currentWordIndex = 0;
        let score = 0;
        let totalPoints = 0;
        let wordsInCurrentBlock = [];
        let selectedVoice = null;

        // DOM Elements
        const mainHeader = document.getElementById('main-header');
        const blockContainer = document.getElementById('block-container');
        const slabContainer = document.getElementById('slab-container');
        const slabWrapper = document.getElementById('slab-block-wrapper');
        const barContainer = document.getElementById('bar-container');
        const barWrapper = document.getElementById('bar-block-wrapper');
        const blockSelectionEl = document.getElementById('block-selection');
        const appCardEl = document.getElementById('app-card');
        const completionScreenEl = document.getElementById('completion-screen');
        const definitionEl = document.getElementById('definition');
        const hearWordBtn = document.getElementById('hear-word');
        const spellInput = document.getElementById('spell-input');
        const checkBtn = document.getElementById('check-btn');
        const feedbackMessageEl = document.getElementById('feedback-message');
        const progressIndicatorEl = document.getElementById('progress-indicator');
        const progressBar = document.getElementById('progress-bar');
        const nextWordBtn = document.getElementById('next-word');
        const prevWordBtn = document.getElementById('prev-word');
        const retryBlockBtn = document.getElementById('retry-block');
        const chooseAnotherBlockBtn = document.getElementById('choose-another-block');
        const finalScoreEl = document.getElementById('final-score');
        const homeBtn = document.getElementById('home-btn');
        const skipBtn = document.getElementById('skip-btn');
        const liveScoreEl = document.getElementById('live-score');
        const addWordBtn = document.getElementById('add-word-btn');
        const addWordModal = document.getElementById('add-word-modal');
        const addWordForm = document.getElementById('add-word-form');
        const cancelAddWordBtn = document.getElementById('cancel-add-word');
        const newWordInput = document.getElementById('new-word');
        const newDefinitionInput = document.getElementById('new-definition');

        // Firebase Setup
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-spellcraft-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        let db, auth, userId, unsubscribeFromData;

        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    loadUserData(userId);
                    initApp();
                } else {
                    try {
                         if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                         } else {
                            await signInAnonymously(auth);
                         }
                    } catch(error) {
                        console.error("Firebase Auth Error:", error);
                        // Initialize app with local data if auth fails
                        initApp();
                    }
                }
            });
        } else {
            console.warn("Firebase config not found. Running in offline mode.");
            initApp();
        }

        function initApp() {
            loadVoices();
            if (typeof speechSynthesis !== 'undefined' && speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = loadVoices;
            }
            setupEventListeners();
            updateAndRenderBlocks();
            updateScoreDisplay();
        }

        // --- Firebase Data Functions ---
        function loadUserData(uid) {
            const dataRef = doc(db, `/artifacts/${appId}/users/${uid}/spellcraftData/data`);
            if (unsubscribeFromData) unsubscribeFromData(); // Unsubscribe from previous listener
            
            unsubscribeFromData = onSnapshot(dataRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    totalPoints = data.totalPoints || 0;
                    incorrectWords = data.incorrectWords || [];
                    barWords = data.barWords || [];
                } else {
                    // No data, use defaults
                    totalPoints = 0;
                    incorrectWords = [];
                    barWords = [];
                }
                updateScoreDisplay();
                updateAndRenderBlocks();
            });
        }

        async function saveUserData() {
            if (!userId) return; // Don't save if not logged in
            const dataRef = doc(db, `/artifacts/${appId}/users/${userId}/spellcraftData/data`);
            try {
                await setDoc(dataRef, {
                    totalPoints,
                    incorrectWords,
                    barWords
                }, { merge: true });
            } catch (error) {
                console.error("Error saving user data:", error);
            }
        }
        
        // --- Core App Logic ---
        function loadVoices() {
            const voices = speechSynthesis.getVoices();
            if (voices.length === 0) return;
            selectedVoice = voices.find(voice => voice.name === 'Google US English') || voices.find(voice => voice.lang === 'en-US' && voice.name.includes('Google')) || voices.find(voice => voice.lang === 'en-US' && !voice.localService) || voices.find(voice => voice.lang === 'en-US');
        }

        function updateAndRenderBlocks() {
            wordBlocks = [];
            for (let i = 0; i < allWords.length; i += BLOCK_SIZE) {
                wordBlocks.push(allWords.slice(i, i + BLOCK_SIZE));
            }
            originalBlockCount = Math.ceil(allWords.length / BLOCK_SIZE);

            let tempIncorrect = [...new Set(incorrectWords.map(w => w.word))].map(word => incorrectWords.find(w => w.word === word));
            let tempBar = [...new Set(barWords.map(w => w.word))].map(word => barWords.find(w => w.word === word));
            
            if (tempIncorrect.length > 0) {
                for (let i = 0; i < tempIncorrect.length; i += BLOCK_SIZE) {
                    wordBlocks.push(tempIncorrect.slice(i, i + BLOCK_SIZE));
                }
            }
            if (tempBar.length > 0) {
                for (let i = 0; i < tempBar.length; i += BLOCK_SIZE) {
                    wordBlocks.push(tempBar.slice(i, i + BLOCK_SIZE));
                }
            }
            renderBlockButtons();
        }

        function renderBlockButtons() {
            blockContainer.innerHTML = '';
            slabContainer.innerHTML = '';
            barContainer.innerHTML = '';

            const slabBlockCount = Math.ceil(incorrectWords.length / BLOCK_SIZE);
            const slabStartIndex = originalBlockCount;
            const barStartIndex = slabStartIndex + slabBlockCount;

            wordBlocks.forEach((block, index) => {
                if(block.length === 0) return;
                const button = document.createElement('button');
                button.dataset.blockIndex = index;
                button.classList.add('block-btn');

                if (index < slabStartIndex) {
                    button.innerHTML = `<i class="ph-fill ph-book-open"></i> Block ${index + 1}`;
                    blockContainer.appendChild(button);
                } else if (index < barStartIndex) {
                    button.innerHTML = `<i class="ph-fill ph-stack-simple"></i> Slab ${index - slabStartIndex + 1}`;
                    button.classList.add('slab');
                    slabContainer.appendChild(button);
                } else {
                    button.innerHTML = `<i class="ph-fill ph-fire"></i> Bar ${index - barStartIndex + 1}`;
                    button.classList.add('bar');
                    barContainer.appendChild(button);
                }
            });

            slabWrapper.classList.toggle('hidden', slabContainer.children.length === 0);
            barWrapper.classList.toggle('hidden', barContainer.children.length === 0);
        }
        
        function setupEventListeners() {
            blockSelectionEl.addEventListener('click', handleBlockSelection);
            hearWordBtn.addEventListener('click', speakWord);
            checkBtn.addEventListener('click', checkSpelling);
            spellInput.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); checkSpelling(); } });
            nextWordBtn.addEventListener('click', () => navigateWord(1));
            prevWordBtn.addEventListener('click', () => navigateWord(-1));
            retryBlockBtn.addEventListener('click', retryBlock);
            chooseAnotherBlockBtn.addEventListener('click', showBlockSelection);
            homeBtn.addEventListener('click', showBlockSelection);
            skipBtn.addEventListener('click', skipWord);
            addWordBtn.addEventListener('click', () => addWordModal.classList.remove('hidden'));
            cancelAddWordBtn.addEventListener('click', () => addWordModal.classList.add('hidden'));
            addWordForm.addEventListener('submit', handleAddWord);
        }

        function handleAddWord(e) {
            e.preventDefault();
            const newWord = newWordInput.value.trim();
            const newDefinition = newDefinitionInput.value.trim();

            if (newWord && newDefinition) {
                if (allWords.some(w => w.word.toLowerCase() === newWord.toLowerCase())) {
                    // Using a custom modal/feedback instead of alert
                    feedbackMessageEl.textContent = 'This word already exists.';
                    feedbackMessageEl.classList.add('incorrect');
                    setTimeout(() => feedbackMessageEl.textContent = '', 2000);
                    return;
                }
                // Note: This adds the word for the current session only.
                // Persisting the main word list would require saving to Firestore.
                allWords.push({ word: newWord, definition: newDefinition });
                addWordForm.reset();
                addWordModal.classList.add('hidden');
                updateAndRenderBlocks();
            }
        }

        function handleBlockSelection(e) {
            const button = e.target.closest('.block-btn');
            if (button) {
                startBlock(parseInt(button.dataset.blockIndex));
            }
        }

        function startBlock(blockIndex) {
            currentBlockIndex = blockIndex;
            wordsInCurrentBlock = [...wordBlocks[blockIndex]].sort(() => Math.random() - 0.5);
            currentWordIndex = 0;
            score = 0;
            mainHeader.classList.add('hidden');
            blockSelectionEl.classList.add('hidden');
            completionScreenEl.classList.add('hidden');
            appCardEl.classList.remove('hidden');
            loadWord();
        }
        
        function loadWord() {
            const currentWord = wordsInCurrentBlock[currentWordIndex];
            definitionEl.textContent = currentWord.definition;
            spellInput.value = '';
            spellInput.focus();
            spellInput.className = 'input-field text-center';
            feedbackMessageEl.innerHTML = '';
            feedbackMessageEl.className = 'feedback text-center font-semibold mt-4 h-6 flex items-center justify-center gap-2';
            updateProgress();
        }

        function speakWord() {
            if ('speechSynthesis' in window) {
                const word = wordsInCurrentBlock[currentWordIndex].word;
                const utterance = new SpeechSynthesisUtterance(word);
                if (selectedVoice) utterance.voice = selectedVoice;
                utterance.rate = 0.9;
                window.speechSynthesis.speak(utterance);
            } else {
                feedbackMessageEl.innerHTML = 'Sorry, text-to-speech is not supported on your browser.';
                feedbackMessageEl.classList.add('incorrect');
            }
        }
        
        async function checkSpelling() {
            if (spellInput.disabled) return;
            const userInput = spellInput.value.trim().toLowerCase();
            const correctWord = wordsInCurrentBlock[currentWordIndex].word.toLowerCase();
            spellInput.disabled = true;

            if (userInput === correctWord) {
                feedbackMessageEl.innerHTML = '<i class="ph-fill ph-check-circle text-2xl"></i> Correct!';
                feedbackMessageEl.classList.add('correct');
                spellInput.classList.add('correct-input');
                score++;
                totalPoints += 10;
                updateScoreDisplay('increase');
                setTimeout(() => navigateWord(1), 1200);
            } else {
                feedbackMessageEl.innerHTML = `<i class="ph-fill ph-x-circle text-2xl"></i> Incorrect! The word was: <strong class="ml-1">${wordsInCurrentBlock[currentWordIndex].word}</strong>`;
                feedbackMessageEl.classList.add('incorrect');
                spellInput.classList.add('incorrect-input');
                totalPoints -= 5;
                updateScoreDisplay('decrease');
                
                const incorrectWord = wordsInCurrentBlock[currentWordIndex];
                const slabStartIndex = originalBlockCount;
                const slabBlockCount = Math.ceil(incorrectWords.length / BLOCK_SIZE);
                const barStartIndex = slabStartIndex + slabBlockCount;

                if (currentBlockIndex >= slabStartIndex && currentBlockIndex < barStartIndex) {
                    if (!barWords.some(item => item.word === incorrectWord.word)) barWords.push(incorrectWord);
                } else if (currentBlockIndex < slabStartIndex) {
                    if (!incorrectWords.some(item => item.word === incorrectWord.word)) incorrectWords.push(incorrectWord);
                }
                setTimeout(() => navigateWord(1), 2500);
            }
            await saveUserData();
        }

        function navigateWord(direction) {
            currentWordIndex += direction;
            if (currentWordIndex >= wordsInCurrentBlock.length) {
                showCompletionScreen();
            } else {
                currentWordIndex = Math.max(0, currentWordIndex);
                spellInput.disabled = false;
                loadWord();
            }
        }

        async function skipWord() {
            if (spellInput.disabled) return;
            totalPoints -= 2;
            updateScoreDisplay('decrease');
            const skippedWord = wordsInCurrentBlock[currentWordIndex];

            const slabStartIndex = originalBlockCount;
            const slabBlockCount = Math.ceil(incorrectWords.length / BLOCK_SIZE);
            const barStartIndex = slabStartIndex + slabBlockCount;

            if (currentBlockIndex >= slabStartIndex && currentBlockIndex < barStartIndex) {
                 if (!barWords.some(item => item.word === skippedWord.word)) barWords.push(skippedWord);
            } else {
                 if (!incorrectWords.some(item => item.word === skippedWord.word)) incorrectWords.push(skippedWord);
            }
            await saveUserData();
            navigateWord(1);
        }

        function updateProgress() {
            const progress = ((currentWordIndex + 1) / wordsInCurrentBlock.length) * 100;
            progressIndicatorEl.textContent = `Word ${currentWordIndex + 1} of ${wordsInCurrentBlock.length}`;
            progressBar.style.width = `${progress}%`;
            prevWordBtn.disabled = currentWordIndex === 0;
        }

        function updateScoreDisplay(changeType) {
            liveScoreEl.textContent = totalPoints;
            liveScoreEl.classList.toggle('text-teal-500', totalPoints >= 0);
            liveScoreEl.classList.toggle('text-red-500', totalPoints < 0);
        }

        function showCompletionScreen() {
            appCardEl.classList.add('hidden');
            completionScreenEl.classList.remove('hidden');
            finalScoreEl.innerHTML = `You spelled <span class="text-teal-600 font-bold">${score} out of ${wordsInCurrentBlock.length}</span> words correctly. <br> Your total score is now <span class="text-teal-600 font-bold">${totalPoints}</span> points!`;
        }

        function retryBlock() {
            startBlock(currentBlockIndex);
        }
        
        function showBlockSelection() {
            mainHeader.classList.remove('hidden');
            completionScreenEl.classList.add('hidden');
            appCardEl.classList.add('hidden');
            blockSelectionEl.classList.remove('hidden');
            updateAndRenderBlocks();
        }
    </script>
</body>
</html>

